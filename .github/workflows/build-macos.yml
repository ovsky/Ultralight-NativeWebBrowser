# .github/workflows/build-macos.yml
# macOS build using SDK archives hosted in the repo's base-sdk branch.

name: Build - macOS (x64)

on:
  pull_request:
  workflow_dispatch:
    inputs:
      sdk_url:
        description: "Override ULTRALIGHT_SDK_URL (raw .7z in base-sdk branch)"
        required: false
        type: string
      version:
        description: "Override ULTRALIGHT_VERSION (eg. 1.4.0)"
        required: false
        type: string
      webbrowser_version:
        description: "Override WebBrowser version used in package filenames (default 'dev')"
        required: false
        type: string
      package_format:
        description: "Package format(s) to produce via CPack (eg. TGZ or DMG or multi 'TGZ;DMG')"
        required: false
        type: string
  workflow_call:
    inputs:
      sdk_url:
        description: "Override ULTRALIGHT_SDK_URL (raw .7z in base-sdk branch)"
        required: false
        type: string
      version:
        description: "Override ULTRALIGHT_VERSION (eg. 1.4.0)"
        required: false
        type: string
      webbrowser_version:
        description: "Override WebBrowser version used in package filenames (default 'dev')"
        required: false
        type: string
      package_format:
        description: "Package format(s) to produce via CPack (eg. TGZ or DMG or multi 'TGZ;DMG')"
        required: false
        default: DMG
        type: string

jobs:
  build:
    runs-on: macos-13
    permissions:
      contents: read
      actions: write
    env:
      ULTRALIGHT_SDK_URL: ${{ inputs.sdk_url || github.event.inputs.sdk_url }}
      ULTRALIGHT_VERSION: ${{ inputs.version || github.event.inputs.version }}
      WEBBROWSER_VERSION: ${{ inputs.webbrowser_version || github.event.inputs.webbrowser_version || 'dev' }}
      PACKAGE_GENERATORS: ${{ inputs.package_format || github.event.inputs.package_format || 'TGZ' }}
      TARGET_ARCH: x64
    steps:
      - name: 0. Configure Git (longpaths, autocrlf=false)
        run: |
          git config --global core.longpaths true
          git config --global core.autocrlf false

      - name: 1. Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: 2. Detect ULTRALIGHT_SDK_URL from repo base-sdk branch (macOS)
        id: detect_url
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${ULTRALIGHT_SDK_URL:-}" ]; then
            echo "ULTRALIGHT_SDK_URL already provided: $ULTRALIGHT_SDK_URL"
            exit 0
          fi
          # First attempt: query GitHub API for latest macOS SDK in sdks branch and pick highest version
          API="https://api.github.com/repos/${{ github.repository }}/contents/sdks?ref=base-sdk"
          echo "Querying GitHub API for SDK files: $API"
          RESP=$(curl -fLs -H "Authorization: Bearer ${GITHUB_TOKEN:-}" -H "Accept: application/vnd.github+json" "$API" || true)
          if [ -n "$RESP" ]; then
            echo "Parsing SDK filenames from API response..."
            # Extract all file names from the JSON (without jq)
            NAMES=$(printf "%s" "$RESP" | grep -oE '"name"\s*:\s*"[^"]+"' | sed -E 's/.*"name"\s*:\s*"([^"]+)".*/\1/')
            echo "Found files in sdks branch:"; printf ' - %s\n' $NAMES | sed 's/^/  /'
            ARCH=$(uname -m)
            # Build a filtered list of macOS archives (supporting various naming conventions)
            MAC_LIST=""
            for nm in $NAMES; do
              case "$nm" in
                ultralight*-sdk-*-mac-*.7z|ultralight*-sdk-*-macos-*.7z|ultralight*-sdk-*-osx-*.7z)
                  MAC_LIST="$MAC_LIST $nm" ;;
              esac
            done
            if [ -n "$MAC_LIST" ]; then
              echo "macOS SDK candidates:"; for f in $MAC_LIST; do echo "  $f"; done
              # Prefer runner arch (arm64 first when on arm64), then x64
              PREF_ARCHES="x64"
              if [ "$ARCH" = "arm64" ]; then PREF_ARCHES="arm64 x64"; fi
              CHOSEN_FILE=""
              CHOSEN_VER=""
              read_version() {
                local v="$1" a r b c
                a="${v%%.*}"; r="${v#*.}"; b="${r%%.*}"; c="${r#*.}"
                printf '%s %s %s' "${a:-0}" "${b:-0}" "${c:-0}"
              }
              ver_gt() {
                # returns 0 (true) if $1 > $2 as semantic version x.y.z
                [ "$1" = "$2" ] && return 1
                set -- $(read_version "$1") $(read_version "$2")
                local a1="$1" a2="$2" a3="$3" b1="$4" b2="$5" b3="$6"
                if [ $((10#$a1)) -gt $((10#$b1)) ]; then return 0; fi
                if [ $((10#$a1)) -lt $((10#$b1)) ]; then return 1; fi
                if [ $((10#$a2)) -gt $((10#$b2)) ]; then return 0; fi
                if [ $((10#$a2)) -lt $((10#$b2)) ]; then return 1; fi
                if [ $((10#$a3)) -gt $((10#$b3)) ]; then return 0; fi
                return 1
              }
              for PA in $PREF_ARCHES; do
                LIST_FOR_ARCH=$(for f in $MAC_LIST; do echo "$f"; done | grep -E "-$PA\.7z$" || true)
                if [ -n "$LIST_FOR_ARCH" ]; then
                  BEST_VER=""; BEST_FILE=""
                  for f in $LIST_FOR_ARCH; do
                    v=$(echo "$f" | sed -E 's/^.*-([0-9]+\.[0-9]+\.[0-9]+)-(mac|macos|osx)-.*$/\1/')
                    if [ -n "$v" ]; then
                      if [ -z "$BEST_VER" ] || ver_gt "$v" "$BEST_VER"; then
                        BEST_VER="$v"; BEST_FILE="$f"
                      fi
                    fi
                  done
                  if [ -n "$BEST_FILE" ]; then
                    CHOSEN_VER="$BEST_VER"
                    CHOSEN_FILE="$BEST_FILE"
                    echo "Selected latest for arch=$PA: version=$CHOSEN_VER file=$CHOSEN_FILE"
                    break
                  fi
                fi
              done
              if [ -n "$CHOSEN_FILE" ]; then
                BASE_RAW="https://raw.githubusercontent.com/${{ github.repository }}/base-sdk/sdks"
                URL="$BASE_RAW/$CHOSEN_FILE"
                echo "Auto-detected latest macOS SDK URL=$URL"
                echo "ULTRALIGHT_SDK_URL=$URL" >> "$GITHUB_ENV"
                echo "ULTRALIGHT_VERSION=$CHOSEN_VER" >> "$GITHUB_ENV"
                echo "url=$URL" >> "$GITHUB_OUTPUT"
                echo "version=$CHOSEN_VER" >> "$GITHUB_OUTPUT"
                exit 0
              fi
            fi
          fi
          HEADER="data/include/Ultralight/Defines.h"
          VERSION=""
          if [ -f "$HEADER" ]; then
            VERSION=$(sed -n 's/^#define[[:space:]]\+ULTRALIGHT_VERSION[[:space:]]\+"\([^"]\+\)".*/\1/p' "$HEADER" | head -n1)
          fi
          if [ -z "$VERSION" ]; then
            if [ -n "${ULTRALIGHT_VERSION:-}" ]; then
              VERSION="$ULTRALIGHT_VERSION"
              echo "ULTRALIGHT_VERSION provided via env: $VERSION"
            else
              VERSION="1.4.0"
              echo "ULTRALIGHT_VERSION not found in header; defaulting to $VERSION"
            fi
          fi
          BASE_RAW="https://raw.githubusercontent.com/${{ github.repository }}/base-sdk/sdks"
          ARCH=$(uname -m)
          echo "Detected ULTRALIGHT_VERSION=$VERSION; ARCH=$ARCH; probing macOS SDK URLs under $BASE_RAW"
          echo "Header path: $HEADER"
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          candidates=()
          prefixes=("ultralight-free-sdk" "ultralight-sdk")
          macnames=("mac" "macos" "osx")
          # Build an ordered list of candidates to probe, preferring arm64 when on arm64
          if [ "$ARCH" = "arm64" ]; then
            for p in "${prefixes[@]}"; do
              for m in "${macnames[@]}"; do
                candidates+=(
                  "$BASE_RAW/$p-$VERSION-$m-arm64.7z"
                )
              done
            done
          fi
          for p in "${prefixes[@]}"; do
            for m in "${macnames[@]}"; do
              candidates+=(
                "$BASE_RAW/$p-$VERSION-$m-x64.7z"
              )
            done
          done
          found=""
          for url in "${candidates[@]}"; do
            echo "Probing $url"
            # Use GET (not HEAD) since some raw endpoints may not respond to HEAD reliably
            if curl -fLs -o /dev/null "$url"; then
              found="$url"; break
            fi
          done
          if [ -n "$found" ]; then
            echo "Auto-detected ULTRALIGHT_SDK_URL=$found"
            echo "ULTRALIGHT_SDK_URL=$found" >> "$GITHUB_ENV"
            echo "url=$found" >> "$GITHUB_OUTPUT"
          else
            echo "::error::Could not auto-detect a valid macOS SDK URL in base-sdk branch for version $VERSION."
            echo "Tried candidates:"; printf ' - %s\n' "${candidates[@]}"
            exit 1
          fi

      - name: 3. Install 7zip (macOS)
        run: |
          brew update
          brew install 7zip || brew install p7zip
          (7z -version || 7zz -version) 2>/dev/null || true

      - name: 4. Prepare Ultralight SDK (macOS)
        id: prep_sdk
        shell: bash
        run: |
          set -euo pipefail
          ROOT_DEFAULT="${{ github.workspace }}/data"
          ROOT="${ULTRALIGHT_SDK_ROOT:-}"
          if [ -z "$ROOT" ]; then ROOT="$ROOT_DEFAULT"; fi
          echo "Initial ULTRALIGHT_SDK_ROOT candidate: $ROOT"
          present="false"
          if [ -d "$ROOT/include" ] && ls "$ROOT/lib"/*.dylib >/dev/null 2>&1; then
            present="true"
          elif [ -n "${ULTRALIGHT_SDK_URL:-}" ]; then
            # Normalize GitHub "blob" URLs to raw links if necessary
            URL_DL="$ULTRALIGHT_SDK_URL"
            if echo "$URL_DL" | grep -qE '^https://github.com/.+/blob/'; then
              ORIG="$URL_DL"
              URL_DL=$(echo "$URL_DL" | sed -E 's#https://github.com/([^/]+)/([^/]+)/blob/(.+)$#https://raw.githubusercontent.com/\1/\2/\3#')
              echo "Normalized GitHub blob URL to raw: $ORIG -> $URL_DL"
            fi
            echo "Downloading Ultralight SDK from ULTRALIGHT_SDK_URL=$URL_DL"
            mkdir -p "$RUNNER_TEMP/sdk"
            pkg="$RUNNER_TEMP/ultralight-sdk"
            # Show headers for debugging (first 20)
            echo "HTTP headers (HEAD):"; (curl -fsIL "$URL_DL" | head -n 20) || true
            curl -L "$URL_DL" -o "$pkg"
            echo "Downloaded SDK archive at: $pkg"; ls -lh "$pkg" || true
            mkdir -p "$RUNNER_TEMP/sdk-extract"
            EXTRACTOR=""
            if command -v 7z >/dev/null 2>&1; then EXTRACTOR=7z; elif command -v 7zz >/dev/null 2>&1; then EXTRACTOR=7zz; fi
            if [ -z "$EXTRACTOR" ]; then echo "7zip extractor not found" >&2; exit 1; fi
            # Validate archive by testing with 7z instead of relying on URL extension
            if ! "$EXTRACTOR" t -y "$pkg" >/dev/null 2>&1; then
              echo "Downloaded file is not a valid 7z archive or is corrupted: $URL_DL" >&2
              echo "file(1) output:"; (command -v file >/dev/null 2>&1 && file "$pkg") || echo "'file' not available"
              exit 1
            fi
            "$EXTRACTOR" x -y -o"$RUNNER_TEMP/sdk-extract" "$pkg"
            echo "Extraction tree (depth 2):"
            find "$RUNNER_TEMP/sdk-extract" -maxdepth 2 -type d -print | sed 's/^/  /'
            ROOT_FOUND=""
            while IFS= read -r -d '' dir; do
              if [ -d "$dir/include" ] && [ -d "$dir/lib" ]; then ROOT_FOUND="$dir"; break; fi
            done < <(find "$RUNNER_TEMP/sdk-extract" -mindepth 1 -maxdepth 3 -type d -print0)
            # Fallback: derive SDK root from any include/Ultralight path
            if [ -z "$ROOT_FOUND" ]; then
              INC_PARENT=$(find "$RUNNER_TEMP/sdk-extract" -type d -path '*/include/Ultralight' -print -quit 2>/dev/null | xargs -I{} dirname {} | xargs -I{} dirname {}) || true
              if [ -n "$INC_PARENT" ] && [ -d "$INC_PARENT/include" ] && { [ -d "$INC_PARENT/lib" ] || [ -d "$INC_PARENT/bin" ]; }; then
                ROOT_FOUND="$INC_PARENT"
              fi
            fi
            if [ -n "$ROOT_FOUND" ]; then
              ROOT="$ROOT_FOUND"; present="true"
            else
              echo "Could not infer ULTRALIGHT_SDK_ROOT from extraction. Showing deeper tree (depth 3):"
              find "$RUNNER_TEMP/sdk-extract" -maxdepth 3 -type d -print | sed 's/^/  /'
            fi
          fi
          echo "present=$present" >> "$GITHUB_OUTPUT"
          if [ "$present" = "true" ]; then
            echo "Using ULTRALIGHT_SDK_ROOT=$ROOT"
            echo "ULTRALIGHT_SDK_ROOT=$ROOT" >> "$GITHUB_ENV"
            echo "Listing selected SDK include and lib:"
            ls -la "$ROOT/include" | head -n 100 || true
            ls -la "$ROOT/lib" || true
          else
            echo "::error::Ultralight macOS SDK not found. Ensure base-sdk branch contains a valid archive or set ULTRALIGHT_SDK_ROOT/ULTRALIGHT_SDK_URL."
            exit 1
          fi

      - name: 5. Configure CMake (Xcode)
        if: steps.prep_sdk.outputs.present == 'true'
        run: |
          cmake --version
          echo "Configuring with ULTRALIGHT_SDK_ROOT=$ULTRALIGHT_SDK_ROOT"
          cmake -S . -B build -DULTRALIGHT_SDK_ROOT="$ULTRALIGHT_SDK_ROOT" -DBUILD_TESTING=ON -DWEBBROWSER_VERSION="$WEBBROWSER_VERSION"

      - name: 6. Build Project (Release)
        if: steps.prep_sdk.outputs.present == 'true'
        run: cmake --build build --config Release --parallel

      - name: 6.8 Run tests (ctest)
        if: steps.prep_sdk.outputs.present == 'true'
        run: ctest --test-dir build -C Release --output-on-failure

      - name: 6.9 Package with CPack (macOS)
        if: steps.prep_sdk.outputs.present == 'true'
        shell: bash
        run: |
          set -euo pipefail
          outdir="${{ github.workspace }}/build"
          mkdir -p "$outdir"
          gens_raw="${PACKAGE_GENERATORS:-TGZ}"
          # Split by semicolon, comma, or whitespace
          IFS=$' ;,\t\n' read -r -a GEN_LIST <<< "$gens_raw"
          echo "Requested package formats: ${GEN_LIST[*]}"
          for g in "${GEN_LIST[@]}"; do
            [ -z "$g" ] && continue
            g_uc=$(echo "$g" | tr '[:lower:]' '[:upper:]')
            gen="$g_uc"
            # Map convenience names
            case "$g_uc" in
              DMG)
                gen="DragNDrop";;
              TGZ|ZIP)
                gen="$g_uc";;
              *)
                # Allow passing exact CPack generator name (eg. DragNDrop)
                gen="$g";;
            esac
            echo "Running CPack for generator: $gen"
            cpack --config build/CPackConfig.cmake -C Release -G "$gen" -V -D CPACK_OUTPUT_FILE_PREFIX="$outdir"
          done

      - name: 7.1 List package outputs
        if: steps.prep_sdk.outputs.present == 'true'
        shell: bash
        run: |
          set -euo pipefail
          echo "Listing build directory after CPack:"; ls -la "${{ github.workspace }}/build" || true
          echo "Searching recursively for produced packages:"
          find "${{ github.workspace }}" -maxdepth 4 -type f \( -name "*.tar.gz" -o -name "*.tgz" -o -name "*.dmg" \) -print || true

      - name: "6.5 Diagnostics: verify runtime contents"
        if: steps.prep_sdk.outputs.present == 'true'
        shell: bash
        run: |
          set -euo pipefail
          candidates=(
            # Multi-config generator (Xcode) common locations
            "build/Release"
            "build/bin/Release"
            "build/Ultralight-WebBrowser/Release"
            "build/samples/Ultralight-WebBrowser/Release"
            # Single-config generator (Unix Makefiles/Ninja) common locations
            "build"
            "build/bin"
            "build/Ultralight-WebBrowser"
            "build/samples/Ultralight-WebBrowser"
          )
          src=""
          for p in "${candidates[@]}"; do
            if [ -d "$p" ]; then src="$p"; break; fi
          done
          if [ -z "$src" ]; then
            echo "Warning: No expected output folder found for diagnostics. Checked: ${candidates[*]}" >&2
            echo "Skipping diagnostics step (non-fatal)."
            exit 0
          fi
          echo "Listing runtime directory: $src"
          ls -la "$src" || true
          echo "Listing dylibs:"
          ls -la "$src"/*.dylib 2>/dev/null || true
          echo "Listing resources:"
          ls -la "$src"/assets/resources 2>/dev/null || true

      - name: 7.2 Upload Packages (TGZ/DMG)
        if: steps.prep_sdk.outputs.present == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ultralight-macos-packages
          path: |
            ${{ github.workspace }}/build/*.tar.gz
            ${{ github.workspace }}/build/*.tgz
            ${{ github.workspace }}/build/*.dmg
            ${{ github.workspace }}/**/*.tar.gz
            ${{ github.workspace }}/**/*.tgz
            ${{ github.workspace }}/**/*.dmg

      - name: 7. Archive Artifacts
        if: steps.prep_sdk.outputs.present == 'true'
        shell: bash
        run: |
          set -euo pipefail
          candidates=(
            # Multi-config generator (Xcode) common locations
            "build/Release"
            "build/bin/Release"
            "build/Ultralight-WebBrowser/Release"
            "build/samples/Ultralight-WebBrowser/Release"
            # Single-config generator (Unix Makefiles/Ninja) common locations
            "build"
            "build/bin"
            "build/Ultralight-WebBrowser"
            "build/samples/Ultralight-WebBrowser"
          )
          src=""
          for p in "${candidates[@]}"; do
            if [ -d "$p" ]; then src="$p"; break; fi
          done
          if [ -z "$src" ]; then
            if [ -d "build" ]; then
              echo "No expected output folder found. Falling back to archiving entire build directory."
              src="build"
            else
              echo "Warning: No expected output folder found and no build directory present. Skipping archive step." >&2
              exit 0
            fi
          fi
          echo "Archiving from: $src"
          dest="$GITHUB_WORKSPACE/ultralight-macos.zip"
          rm -f "$dest" 2>/dev/null || true
          (cd "$src" && zip -r "$dest" .)

      - name: 8. Upload Artifact
        if: steps.prep_sdk.outputs.present == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ultralight-macos-build
          path: ultralight-macos.zip

      - name: 9. Delete large packages artifact (cleanup)
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const artifactName = 'ultralight-macos-packages';
            const {owner, repo} = context.repo;
            const run_id = context.runId;
            core.info(`Searching artifacts for run ${run_id} in ${owner}/${repo}...`);
            const res = await github.rest.actions.listWorkflowRunArtifacts({ owner, repo, run_id });
            const artifacts = res.data.artifacts || [];
            const target = artifacts.find(a => a.name === artifactName);
            if (target) {
              core.info(`Deleting artifact '${artifactName}' (id=${target.id}, size=${target.size_in_bytes} bytes)`);
              await github.rest.actions.deleteArtifact({ owner, repo, artifact_id: target.id });
              core.info(`Deleted '${artifactName}'.`);
            } else {
              core.info(`Artifact '${artifactName}' not found for this run; nothing to delete.`);
            }
