# .github/workflows/build-linux.yml
# Linux build using SDK archives hosted in the repo's sdks branch.

name: Build - Linux

on:
  pull_request:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: 1. Checkout Code (with submodules)
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: 2. Detect ULTRALIGHT_SDK_URL from repo sdks branch (Linux)
        id: detect_url
        shell: bash
        run: |
          set -euo pipefail
          if [ -n "${ULTRALIGHT_SDK_URL:-}" ]; then
            echo "ULTRALIGHT_SDK_URL already provided: $ULTRALIGHT_SDK_URL"
            exit 0
          fi
          # First attempt: auto-detect latest Linux SDK by listing sdks branch via GitHub API
          API="https://api.github.com/repos/${{ github.repository }}/contents/sdks?ref=sdks"
          echo "Querying GitHub API for SDK files: $API"
          RESP=$(curl -fLs -H "Authorization: Bearer ${GITHUB_TOKEN:-}" -H "Accept: application/vnd.github+json" "$API" || true)
          if [ -n "$RESP" ]; then
            echo "Parsing SDK filenames from API response..."
            NAMES=$(printf "%s" "$RESP" | grep -oE '"name"\s*:\s*"[^"]+"' | sed -E 's/.*"name"\s*:\s*"([^"]+)".*/\1/')
            echo "Found files in sdks branch:"; printf ' - %s\n' $NAMES | sed 's/^/  /'
            ARCH=$(uname -m)
            PREF_ARCH="x64"; if [ "$ARCH" = "aarch64" ] || [ "$ARCH" = "arm64" ]; then PREF_ARCH="arm64"; fi
            # Filter linux archives
            LINUX_LIST=$(for nm in $NAMES; do case "$nm" in ultralight*-sdk-*-linux-*.7z) echo "$nm";; esac; done)
            if [ -n "$LINUX_LIST" ]; then
              read_version() { local v="$1" a r b c; a="${v%%.*}"; r="${v#*.}"; b="${r%%.*}"; c="${r#*.}"; printf '%s %s %s' "${a:-0}" "${b:-0}" "${c:-0}"; }
              ver_gt() { [ "$1" = "$2" ] && return 1; set -- $(read_version "$1") $(read_version "$2"); local a1="$1" a2="$2" a3="$3" b1="$4" b2="$5" b3="$6"; if [ $((10#$a1)) -gt $((10#$b1)) ]; then return 0; fi; if [ $((10#$a1)) -lt $((10#$b1)) ]; then return 1; fi; if [ $((10#$a2)) -gt $((10#$b2)) ]; then return 0; fi; if [ $((10#$a2)) -lt $((10#$b2)) ]; then return 1; fi; if [ $((10#$a3)) -gt $((10#$b3)) ]; then return 0; fi; return 1; }
              BEST_VER=""; BEST_FILE=""
              for f in $LINUX_LIST; do
                case "$f" in *-linux-$PREF_ARCH.7z) : ;; *) continue;; esac
                v=$(echo "$f" | sed -E 's/^.*-([0-9]+\.[0-9]+\.[0-9]+)-linux-.*$/\1/')
                if [ -n "$v" ]; then if [ -z "$BEST_VER" ] || ver_gt "$v" "$BEST_VER"; then BEST_VER="$v"; BEST_FILE="$f"; fi; fi
              done
              if [ -z "$BEST_FILE" ] && [ "$PREF_ARCH" = "arm64" ]; then
                # Fallback to x64 if no arm64 archive present
                for f in $LINUX_LIST; do
                  case "$f" in *-linux-x64.7z) : ;; *) continue;; esac
                  v=$(echo "$f" | sed -E 's/^.*-([0-9]+\.[0-9]+\.[0-9]+)-linux-.*$/\1/')
                  if [ -n "$v" ]; then if [ -z "$BEST_VER" ] || ver_gt "$v" "$BEST_VER"; then BEST_VER="$v"; BEST_FILE="$f"; fi; fi
                done
              fi
              if [ -n "$BEST_FILE" ]; then
                BASE_RAW="https://raw.githubusercontent.com/${{ github.repository }}/sdks/sdks"
                URL="$BASE_RAW/$BEST_FILE"
                echo "Auto-detected latest Linux SDK URL=$URL"
                echo "ULTRALIGHT_SDK_URL=$URL" >> "$GITHUB_ENV"
                echo "ULTRALIGHT_VERSION=$BEST_VER" >> "$GITHUB_ENV"
                echo "url=$URL" >> "$GITHUB_OUTPUT"
                echo "version=$BEST_VER" >> "$GITHUB_OUTPUT"
                exit 0
              fi
            fi
          fi
          HEADER="data/include/Ultralight/Defines.h"
          VERSION=""
          if [ -f "$HEADER" ]; then
            VERSION=$(sed -n 's/^#define[[:space:]]\+ULTRALIGHT_VERSION[[:space:]]\+"\([^"]\+\)".*/\1/p' "$HEADER" | head -n1)
          fi
          if [ -z "$VERSION" ]; then
            if [ -n "${ULTRALIGHT_VERSION:-}" ]; then
              VERSION="$ULTRALIGHT_VERSION"
              echo "ULTRALIGHT_VERSION provided via env: $VERSION"
            else
              VERSION="1.4.0"
              echo "ULTRALIGHT_VERSION not found in header; defaulting to $VERSION"
            fi
          fi
          BASE_RAW="https://raw.githubusercontent.com/${{ github.repository }}/sdks/sdks"
          echo "Detected ULTRALIGHT_VERSION=$VERSION; probing Linux SDK URLs under $BASE_RAW"
          echo "Header path: $HEADER"
          echo "Repository: ${{ github.repository }}"
          echo "Commit: ${{ github.sha }}"
          candidates=(
            "$BASE_RAW/ultralight-free-sdk-$VERSION-linux-x64.7z"
            "$BASE_RAW/ultralight-free-sdk-$VERSION-linux-arm64.7z"
          )
          found=""
          for url in "${candidates[@]}"; do
            echo "Probing $url"
            # Use GET (not HEAD) for reliability with raw endpoints
            if curl -fLs -o /dev/null "$url"; then
              found="$url"; break
            fi
          done
          if [ -n "$found" ]; then
            echo "Auto-detected ULTRALIGHT_SDK_URL=$found"
            echo "ULTRALIGHT_SDK_URL=$found" >> "$GITHUB_ENV"
            echo "url=$found" >> "$GITHUB_OUTPUT"
          else
            echo "::error::Could not auto-detect a valid Linux SDK URL in sdks branch for version $VERSION."
            echo "Tried candidates:"; printf ' - %s\n' "${candidates[@]}"
            exit 1
          fi

      - name: 3. Install 7zip (Linux)
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full

      - name: 3.5 Install linters (clang-format, cppcheck)
        run: |
          sudo apt-get update
          sudo apt-get install -y clang-format cppcheck

      - name: 4. Prepare Ultralight SDK (Linux)
        id: prep_sdk
        shell: bash
        run: |
          set -euo pipefail
          ROOT_DEFAULT="${{ github.workspace }}/data"
          ROOT="${ULTRALIGHT_SDK_ROOT:-}"
          if [ -z "$ROOT" ]; then ROOT="$ROOT_DEFAULT"; fi
          echo "Initial ULTRALIGHT_SDK_ROOT candidate: $ROOT"
          present="false"
          if [ -d "$ROOT/include" ] && ls "$ROOT/lib"/*.so >/dev/null 2>&1; then
            present="true"
          elif [ -n "${ULTRALIGHT_SDK_URL:-}" ]; then
            echo "Downloading Ultralight SDK from ULTRALIGHT_SDK_URL=$ULTRALIGHT_SDK_URL"
            mkdir -p "$RUNNER_TEMP/sdk"
            pkg="$RUNNER_TEMP/ultralight-sdk"
            curl -L "$ULTRALIGHT_SDK_URL" -o "$pkg"
            echo "Downloaded SDK archive at: $pkg"; ls -lh "$pkg" || true
            mkdir -p "$RUNNER_TEMP/sdk-extract"
            # Enforce 7z format and extract with available 7z tool
            if ! echo "$ULTRALIGHT_SDK_URL" | grep -Ei '\\.(7z)$' >/dev/null; then
              echo "Expected a .7z SDK archive, got: $ULTRALIGHT_SDK_URL" >&2; exit 1
            fi
            EXTRACTOR=""
            if command -v 7z >/dev/null 2>&1; then EXTRACTOR=7z; elif command -v 7zz >/dev/null 2>&1; then EXTRACTOR=7zz; fi
            if [ -z "$EXTRACTOR" ]; then echo "7zip extractor not found" >&2; exit 1; fi
            "$EXTRACTOR" x -y -o"$RUNNER_TEMP/sdk-extract" "$pkg"
            echo "Extraction tree (depth 2):"
            find "$RUNNER_TEMP/sdk-extract" -maxdepth 2 -type d -print | sed 's/^/  /'
            ROOT_FOUND=""
            while IFS= read -r -d '' dir; do
              if [ -d "$dir/include" ] && [ -d "$dir/lib" ]; then ROOT_FOUND="$dir"; break; fi
            done < <(find "$RUNNER_TEMP/sdk-extract" -mindepth 1 -maxdepth 3 -type d -print0)
            if [ -n "$ROOT_FOUND" ]; then
              ROOT="$ROOT_FOUND"; present="true"
            fi
          fi
          echo "present=$present" >> "$GITHUB_OUTPUT"
          if [ "$present" = "true" ]; then
            echo "Using ULTRALIGHT_SDK_ROOT=$ROOT"
            echo "ULTRALIGHT_SDK_ROOT=$ROOT" >> "$GITHUB_ENV"
            echo "Listing selected SDK include and lib:"
            ls -la "$ROOT/include" | head -n 100 || true
            ls -la "$ROOT/lib" || true
          else
            echo "::error::Ultralight Linux SDK not found. Ensure sdks branch contains a valid archive or set ULTRALIGHT_SDK_ROOT/ULTRALIGHT_SDK_URL."
            exit 1
          fi

      - name: 5. Install Linux Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libgtk-3-dev libnss3-dev libgdk-pixbuf2.0-dev libxtst-dev libxss-dev libdbus-glib-1-dev

      - name: 5.5 Lint (clang-format) and Static Analysis (cppcheck)
        shell: bash
        run: |
          set -euo pipefail
          echo "clang-format version:"; clang-format --version
          files=$(ls src/*.cpp src/*.h 2>/dev/null || true)
          if [ -n "$files" ]; then
            echo "$files" | xargs -I{} clang-format -n --Werror {}
          else
            echo "No source files found for clang-format check."
          fi
          echo "Running cppcheck..."
          cppcheck --version
          cppcheck --enable=warning,style,performance,portability --inline-suppr --error-exitcode=1 -I "$ULTRALIGHT_SDK_ROOT/include" src || (echo "cppcheck failed"; exit 1)

      - name: 6. Configure CMake
        if: steps.prep_sdk.outputs.present == 'true'
        run: |
          cmake --version
          echo "Configuring with ULTRALIGHT_SDK_ROOT=$ULTRALIGHT_SDK_ROOT"
          cmake -S . -B build -DCMAKE_BUILD_TYPE=Release -DULTRALIGHT_SDK_ROOT="$ULTRALIGHT_SDK_ROOT" -DBUILD_TESTING=ON

      - name: 7. Build Project
        if: steps.prep_sdk.outputs.present == 'true'
        run: cmake --build build --parallel -- VERBOSE=1

      - name: 7.8 Run tests (ctest)
        if: steps.prep_sdk.outputs.present == 'true'
        run: ctest --test-dir build --output-on-failure

      - name: "7.5 Diagnostics: verify runtime contents"
        if: steps.prep_sdk.outputs.present == 'true'
        shell: bash
        run: |
          set -euo pipefail
          candidates=(
            "build"
            "build/bin"
            "build/Ultralight-WebBrowser"
            "build/samples/Ultralight-WebBrowser"
          )
          src=""
          for p in "${candidates[@]}"; do
            if [ -d "$p" ]; then src="$p"; break; fi
          done
          if [ -z "$src" ]; then
            echo "No expected output folder found for diagnostics. Checked: ${candidates[*]}" >&2
            exit 1
          fi
          echo "Listing runtime directory: $src"
          ls -la "$src" || true
          echo "Listing shared libs:"
          ls -la "$src"/*.so 2>/dev/null || true
          echo "Listing resources:"
          ls -la "$src"/assets/resources 2>/dev/null || true

      - name: 8. Archive Artifacts
        if: steps.prep_sdk.outputs.present == 'true'
        shell: bash
        run: |
          set -euo pipefail
          candidates=(
            "build"
            "build/bin"
            "build/Ultralight-WebBrowser"
            "build/samples/Ultralight-WebBrowser"
          )
          src=""
          for p in "${candidates[@]}"; do
            if [ -d "$p" ]; then src="$p"; break; fi
          done
          if [ -z "$src" ]; then
            echo "No expected output folder found. Checked: ${candidates[*]}" >&2
            exit 1
          fi
          echo "Archiving from: $src"
          cd "$src"
          zip -r ../../ultralight-linux.zip .

      - name: 9. Upload Artifact
        if: steps.prep_sdk.outputs.present == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: ultralight-linux-build
          path: ultralight-linux.zip
