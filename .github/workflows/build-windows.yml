# .github/workflows/windows-build.yml
#
# Builds the project on Windows (Visual Studio)
# This uses a multi-config generator, so the --config flag
# is used during the build step.

name: Build - Windows

on:
  workflow_dispatch:
    inputs:
      sdk_url:
        description: "Override ULTRALIGHT_SDK_URL (raw .7z in base-sdk branch)"
        required: false
        type: string
      version:
        description: "Override ULTRALIGHT_VERSION (eg. 1.4.0)"
        required: false
        type: string
      webbrowser_version:
        description: "Override build version name (default 'dev')"
        required: false
        type: string
      create_installer:
        description: "Create Windows installer via CPack (NSIS)"
        required: false
        type: boolean
      development_build:
        description: "Development build (keeps intermediate packages, verbose logs)"
        required: false
        type: boolean
        default: false
  workflow_call:
    inputs:
      sdk_url:
        description: "Override ULTRALIGHT_SDK_URL (raw .7z in base-sdk branch)"
        required: false
        type: string
      version:
        description: "Override ULTRALIGHT_VERSION (eg. 1.4.0)"
        required: false
        type: string
      webbrowser_version:
        description: "Override build version name (default 'dev')"
        required: false
        type: string
      create_installer:
        description: "Create Windows installer via CPack (NSIS)"
        required: false
        type: boolean
        default: false
      development_build:
        description: "Development build (keeps intermediate packages, verbose logs)"
        required: false
        type: boolean
        default: false

jobs:
  build:
    runs-on: windows-latest
    env:
      ULTRALIGHT_SDK_URL: ${{ inputs.sdk_url || github.event.inputs.sdk_url }}
      ULTRALIGHT_VERSION: ${{ inputs.version || github.event.inputs.version }}
      WEBBROWSER_VERSION: ${{ inputs.webbrowser_version || github.event.inputs.webbrowser_version || 'dev' }}
      CREATE_INSTALLER: ${{ inputs.create_installer || github.event.inputs.create_installer }}
      DEVELOPMENT_BUILD: ${{ inputs.development_build || github.event.inputs.development_build || 'false' }}

    steps:
      - name: "0. Configure Git (longpaths, autocrlf=false)"
        shell: pwsh
        run: |
          git config --global core.longpaths true
          git config --global core.autocrlf false

      - name: "1. Checkout Code (with submodules)"
        uses: actions/checkout@v4
        with:
          submodules: "recursive"

      - name: "2. Detect ULTRALIGHT_SDK_URL from repo base-sdk branch (Windows)"
        id: detect_url
        shell: pwsh
        run: |
          if ($env:ULTRALIGHT_SDK_URL) {
            Write-Host "ULTRALIGHT_SDK_URL already provided: $env:ULTRALIGHT_SDK_URL"
            exit 0
          }
          # First attempt: Use GitHub API to list sdks branch and pick latest Windows SDK (x64)
          $api = "https://api.github.com/repos/${{ github.repository }}/contents/sdks?ref=base-sdk"
          $headers = @{ Authorization = "Bearer $env:GITHUB_TOKEN"; Accept = "application/vnd.github+json" }
          Write-Host "Querying GitHub API for SDK files: $api"
          try { $resp = Invoke-RestMethod -Uri $api -Headers $headers -Method Get -UseBasicParsing } catch { $resp = $null }
          if ($resp) {
            $names = @($resp | Where-Object { $_.type -eq 'file' } | ForEach-Object { $_.name })
            if ($names.Count -gt 0) {
              Write-Host "Found files in sdks branch:"; $names | ForEach-Object { Write-Host "  $_" }
              $candidates = @()
              foreach ($n in $names) {
                if ($n -match '^ultralight(-free)?-sdk-([0-9]+\.[0-9]+\.[0-9]+)-(win|windows)-x64\.7z$') { $candidates += $n }
              }
              if ($candidates.Count -gt 0) {
                $best = $null
                foreach ($f in $candidates) {
                  $m = [regex]::Match($f, '([0-9]+\.[0-9]+\.[0-9]+)')
                  if ($m.Success) {
                    $ver = [version]$m.Groups[1].Value
                    if (-not $best -or $ver -gt $best.Version) { $best = [pscustomobject]@{ Version=$ver; File=$f } }
                  }
                }
                if ($best) {
                  $baseRaw = "https://raw.githubusercontent.com/${{ github.repository }}/base-sdk/sdks"
                  $url = "$baseRaw/$($best.File)"
                  Write-Host "Auto-detected latest Windows SDK URL=$url"
                  "ULTRALIGHT_SDK_URL=$url" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
                  "ULTRALIGHT_VERSION=$($best.Version.ToString())" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
                  "url=$url" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
                  "version=$($best.Version.ToString())" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
                  exit 0
                }
              }
            }
          }
          $header = "data/include/Ultralight/Defines.h"
          $version = $null
          if (Test-Path $header) {
            $matchLine = Select-String -Path $header -Pattern '^#define\s+ULTRALIGHT_VERSION\s+"([^"]+)"' | Select-Object -First 1
            if ($matchLine) { $version = $matchLine.Matches[0].Groups[1].Value }
          }
          if (-not $version) {
            if ($env:ULTRALIGHT_VERSION) { $version = $env:ULTRALIGHT_VERSION; Write-Host "ULTRALIGHT_VERSION provided via env: $version" }
            else { $version = '1.4.0'; Write-Host "ULTRALIGHT_VERSION not found in header; defaulting to $version" }
          }
          $baseRaw = "https://raw.githubusercontent.com/${{ github.repository }}/base-sdk/sdks"
          Write-Host "Detected ULTRALIGHT_VERSION=$version; probing Windows SDK URLs under $baseRaw"
          Write-Host "Header path: $header"
          Write-Host "Repository: ${{ github.repository }}"
          Write-Host "Commit: ${{ github.sha }}"
          $candidates = @(
            "$baseRaw/ultralight-free-sdk-$version-win-x64.7z",
            "$baseRaw/ultralight-free-sdk-$version-windows-x64.7z"
          )
          function Test-Url($u) {
            try { $r = Invoke-WebRequest -Uri $u -Method Head -UseBasicParsing; return $true } catch {}
            try {
              $tmp = Join-Path $env:RUNNER_TEMP "probe.tmp"
              Invoke-WebRequest -Uri $u -Method Get -UseBasicParsing -OutFile $tmp | Out-Null
              Remove-Item $tmp -ErrorAction SilentlyContinue
              return $true
            } catch { return $false }
          }
          $found = $null
          foreach ($url in $candidates) {
            Write-Host "Probing $url"
            if (Test-Url $url) { $found = $url; break }
          }
          if ($found) {
            Write-Host "Auto-detected ULTRALIGHT_SDK_URL=$found"
            "ULTRALIGHT_SDK_URL=$found" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            "url=$found" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          } else {
            Write-Error "Could not auto-detect a valid Windows SDK URL in base-sdk branch for version $version."
            exit 1
          }

      - name: "3. Install 7zip"
        shell: pwsh
        run: |
          # Install 7-Zip and verify with a benign command that returns exit code 0
          choco install 7zip -y --no-progress
          $sevenZipExe = Join-Path $env:ProgramFiles '7-Zip/7z.exe'
          if (Test-Path $sevenZipExe) {
            # Make 7z available for subsequent steps in this job
            (Split-Path $sevenZipExe) | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            & $sevenZipExe i | Out-Host
          } else {
            # Fallback to PATH if 7z is already present on the runner image
            if (Get-Command 7z -ErrorAction SilentlyContinue) {
              7z i | Out-Host
            } else {
              Write-Error "7z.exe not found after installation."
              exit 1
            }
          }

      - name: "3.1 Install NSIS (for installer creation)"
        if: ${{ inputs.create_installer == true }}
        shell: pwsh
        run: |
          Write-Host "Installing NSIS for Windows installer creation..."
          choco install nsis -y --no-progress
          $nsisPath = "C:\Program Files (x86)\NSIS\makensis.exe"
          if (Test-Path $nsisPath) {
            Write-Host "NSIS installed successfully at: $nsisPath"
            # Add to PATH for CPack
            "C:\Program Files (x86)\NSIS" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
          } else {
            Write-Warning "NSIS installation completed but executable not found at expected location"
          }

      - name: "4. Prepare Ultralight SDK (Windows)"
        id: prep_sdk
        shell: pwsh
        run: |
          $rootDefault = Join-Path $env:GITHUB_WORKSPACE 'data'
          $root = $env:ULTRALIGHT_SDK_ROOT
          if (-not $root) { $root = $rootDefault }
          Write-Host "Initial ULTRALIGHT_SDK_ROOT candidate: $root"
          $present = 'false'
          if ((Test-Path (Join-Path $root 'include')) -and ((Test-Path (Join-Path $root 'lib')) -or (Test-Path (Join-Path $root 'bin')))) {
            $present = 'true'
          } elseif ($env:ULTRALIGHT_SDK_URL) {
            # Normalize GitHub blob URLs to raw
            $dlUrl = $env:ULTRALIGHT_SDK_URL
            if ($dlUrl -match '^https://github.com/([^/]+)/([^/]+)/blob/(.+)$') {
              $orig = $dlUrl
              $dlUrl = "https://raw.githubusercontent.com/$($Matches[1])/$($Matches[2])/$($Matches[3])"
              Write-Host "Normalized GitHub blob URL to raw: $orig -> $dlUrl"
            }
            Write-Host "Downloading Ultralight SDK from ULTRALIGHT_SDK_URL=$dlUrl"
            $pkg = Join-Path $env:RUNNER_TEMP 'ultralight-sdk'
            try { $head = Invoke-WebRequest -Uri $dlUrl -UseBasicParsing -Method Head } catch {}
            if ($head) { Write-Host ("HEAD status: {0}" -f $head.StatusCode); $head.Headers.GetEnumerator() | Select-Object -First 12 | ForEach-Object { Write-Host ("  {0}: {1}" -f $_.Key, $_.Value) } }
            Invoke-WebRequest -Uri $dlUrl -UseBasicParsing -OutFile $pkg
            Write-Host "Downloaded SDK archive at: $pkg"
            Get-Item $pkg | Format-List -Property FullName,Length
            $extract = Join-Path $env:RUNNER_TEMP 'sdk-extract'
            New-Item -ItemType Directory -Force -Path $extract | Out-Null
            # Validate archive by testing with 7z instead of relying on URL extension
            $test = & 7z t -y "$pkg" 2>$null; if ($LASTEXITCODE -ne 0) {
              Write-Error "Downloaded file is not a valid 7z archive or is corrupted: $dlUrl";
              try { Get-Item "$pkg" | Format-List -Property FullName,Length,CreationTime } catch {}
              exit 1
            }
            & 7z x -y -o"$extract" "$pkg" | Out-Null
            Write-Host "Extraction tree (depth 2):"
            Get-ChildItem -Path $extract -Depth 2 -Directory | ForEach-Object { $_.FullName } | ForEach-Object { "  $_" }
            $rootFound = Get-ChildItem -Path $extract -Recurse -Directory | Where-Object { Test-Path (Join-Path $_.FullName 'include') -and Test-Path (Join-Path $_.FullName 'lib') } | Select-Object -First 1
            if ($rootFound) { $root = $rootFound.FullName; $present = 'true' }
          }
          "present=$present" | Out-File -FilePath $env:GITHUB_OUTPUT -Encoding utf8 -Append
          if ($present -eq 'true') {
            Write-Host "Using ULTRALIGHT_SDK_ROOT=$root"
            "ULTRALIGHT_SDK_ROOT=$root" | Out-File -FilePath $env:GITHUB_ENV -Encoding utf8 -Append
            Write-Host "Listing selected SDK include and lib:"
            if (Test-Path (Join-Path $root 'include')) { Get-ChildItem -Force (Join-Path $root 'include') | Select-Object -First 50 | Format-List -Property Mode,Length,Name }
            if (Test-Path (Join-Path $root 'lib')) { Get-ChildItem -Force (Join-Path $root 'lib') | Format-List -Property Mode,Length,Name }
          } else {
            Write-Error "Ultralight Windows SDK not found. Ensure base-sdk branch contains a valid archive or set ULTRALIGHT_SDK_ROOT/ULTRALIGHT_SDK_URL."; exit 1
          }

      - name: "5. Configure CMake"
        if: steps.prep_sdk.outputs.present == 'true'
        run: |
          cmake --version
          Write-Host "Configuring with ULTRALIGHT_SDK_ROOT=$env:ULTRALIGHT_SDK_ROOT"
          $createInstaller = "$env:CREATE_INSTALLER"
          if ($createInstaller -eq '' -or $null -eq $createInstaller) { $createInstaller = 'false' }
          $installerFlag = if ($createInstaller -match '^(true|1|on)$') { 'ON' } else { 'OFF' }
          Write-Host "CREATE_INSTALLER=$createInstaller -> -DCREATE_INSTALLER=$installerFlag"
          cmake -S . -B build -DULTRALIGHT_SDK_ROOT="${{ env.ULTRALIGHT_SDK_ROOT }}" -DBUILD_TESTING=ON -DCREATE_INSTALLER=$installerFlag -DWEBBROWSER_VERSION="$env:WEBBROWSER_VERSION"

      - name: "6. Build Project"
        # We specify the 'Release' config at build time
        run: cmake --build build --config Release --parallel

      - name: "6.15 Install NSIS (for installer)"
        if: ${{ inputs.create_installer == true }}
        shell: pwsh
        run: |
          choco install nsis -y --no-progress
          $nsisDir = Join-Path ${env:ProgramFiles(x86)} 'NSIS'
          if (Test-Path (Join-Path $nsisDir 'makensis.exe')) {
            # Ensure makensis is available in PATH for this and later steps
            $nsisDir | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
            & (Join-Path $nsisDir 'makensis.exe') /VERSION | Out-Host
          } else {
            Write-Warning "NSIS makensis.exe not found after install; CPack NSIS may not be available."
          }

      - name: "6.2 Package (CPack)"
        if: ${{ inputs.create_installer == true }}
        shell: pwsh
        run: |
          Write-Host "Packaging with CPack (Release config)"
          pushd build

          # Create CPack ZIP package with proper naming
          Write-Host "Creating CPack ZIP package..."
          cpack -C Release -G ZIP

          # Rename CPack ZIP to final name
          $version = "$env:WEBBROWSER_VERSION"
          $cpackZip = Get-ChildItem -Path . -Filter "*.zip" -File | Select-Object -First 1
          if ($cpackZip) {
            $finalZipName = "Ultralight-WebBrowser-$version-Windows-x64.zip"
            Write-Host "Renaming CPack ZIP: $($cpackZip.Name) -> $finalZipName"
            Move-Item -Force $cpackZip.FullName $finalZipName
          }

          # Check if NSIS is available before attempting to create installer
          $nsisPath = "C:\Program Files (x86)\NSIS\makensis.exe"
          if (Test-Path $nsisPath) {
            Write-Host "NSIS found at: $nsisPath"
            Write-Host "Creating NSIS installer..."
            try {
              cpack -C Release -G NSIS
              Write-Host "NSIS installer created successfully"

              # Rename NSIS installer to final name
              $exe = Get-ChildItem -Path . -Filter *.exe -File | Where-Object { $_.Name -notlike '*CompilerIdCXX*' } | Select-Object -First 1
              if ($exe) {
                $finalInstallerName = "Ultralight-WebBrowser-$version-Windows-x64-Installer.exe"
                Write-Host "Renaming installer: $($exe.Name) -> $finalInstallerName"
                Move-Item -Force $exe.FullName $finalInstallerName
              }
            } catch {
              Write-Warning "NSIS installer creation failed: $_"
              Write-Warning "Continuing without installer..."
            }
          } else {
            Write-Warning "NSIS not found at: $nsisPath"
            Write-Warning "Skipping NSIS installer generation."
          }

          popd
          Write-Host "Final CPack outputs:"
          Get-ChildItem -Path build -Include "Ultralight-WebBrowser-*" -File | Select-Object -Property Name,Length | Format-Table -AutoSize

      - name: "6.8 Run tests (ctest)"
        run: ctest --test-dir build -C Release --output-on-failure

      - name: "6.5 Diagnostics: verify runtime contents"
        if: ${{ env.DEVELOPMENT_BUILD == 'true' }}
        shell: pwsh
        run: |
          $candidates = @(
            'build\Release',
            'build\bin\Release',
            'build\Ultralight-WebBrowser\Release',
            'build\samples\Ultralight-WebBrowser\Release'
          )
          $src = $null
          foreach ($p in $candidates) {
            if (Test-Path $p) { $src = $p; break }
          }
          if (-not $src) { throw "No expected output folder found for diagnostics. Checked: $($candidates -join ', ')" }
          Write-Host "Listing runtime directory: $src"
          Get-ChildItem -Force $src | Format-List -Property Mode,Length,Name
          Write-Host "Listing DLLs:"; Get-ChildItem -Path (Join-Path $src '*.dll') -ErrorAction SilentlyContinue | Format-List -Property Mode,Length,Name
          Write-Host "Listing resources:"; if (Test-Path (Join-Path $src 'assets/resources')) { Get-ChildItem -Force (Join-Path $src 'assets/resources') | Format-List -Property Mode,Length,Name } else { Write-Host 'assets/resources not found' }

      - name: "7. Upload Final Packages"
        if: ${{ inputs.create_installer == true }}
        uses: actions/upload-artifact@v4
        with:
          name: Ultralight-WebBrowser-${{ env.WEBBROWSER_VERSION }}-Windows-x64
          path: |
            build/Ultralight-WebBrowser-*-Windows-x64.zip
            build/Ultralight-WebBrowser-*-Windows-x64-Installer.exe
          if-no-files-found: warn

      - name: "7.1 Upload Intermediate Packages (Development Only)"
        if: ${{ env.DEVELOPMENT_BUILD == 'true' }}
        continue-on-error: true
        uses: actions/upload-artifact@v4
        with:
          name: Ultralight-WebBrowser-${{ env.WEBBROWSER_VERSION }}-Windows-x64-Intermediate
          path: build/_CPack_Packages/
          if-no-files-found: warn
