# .github/workflows/windows-build.yml
#
# Builds the project on Windows (Visual Studio)
# This uses a multi-config generator, so the --config flag
# is used during the build step.

name: Build - Windows

on:
  push:
    branches: ["main", "dev"]
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: "1. Checkout Code (with submodules)"
        uses: actions/checkout@v4
        with:
          submodules: "recursive"

      - name: "2. Configure CMake"
        # No build type needed here; Visual Studio will handle it
        run: cmake -S . -B build

      - name: "3. Build Project"
        # We specify the 'Release' config at build time
        run: cmake --build build --config Release --parallel

      - name: "4. Archive Artifacts"
        # For multi-config, Visual Studio places outputs in 'build/Release'
        # We use PowerShell's Compress-Archive
        shell: pwsh
        run: |
          # Detect the actual output folder and zip it (handles different generators/layouts)
          $candidates = @(
            'build\Release',
            'build\bin\Release',
            'build\Ultralight-WebBrowser\Release',
            'build\samples\Ultralight-WebBrowser\Release'
          )
          $src = $null
          foreach ($p in $candidates) {
            if (Test-Path $p) { $src = $p; break }
          }
          if (-not $src) {
            throw "No expected output folder found. Checked: $($candidates -join ', ')"
          }
          Write-Host "Archiving from: $src"
          Compress-Archive -Path (Join-Path $src '*') -DestinationPath ultralight-windows.zip -Force

      - name: "5. Upload Artifact"
        uses: actions/upload-artifact@v4
        with:
          name: ultralight-windows-build
          path: ultralight-windows.zip
