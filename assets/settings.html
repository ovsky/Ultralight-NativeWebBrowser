<!doctype html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Ultralight Browser Settings</title>
    <style>
        :root {
            color-scheme: dark;
            --bg: #0e0f18;
            --bg-accent: radial-gradient(circle at 20% 15%, rgba(105, 126, 220, 0.3), rgba(14, 15, 24, 0.95) 58%);
            --surface: rgba(25, 26, 38, 0.92);
            --surface-alt: rgba(32, 32, 48, 0.92);
            --surface-raised: rgba(45, 46, 68, 0.82);
            --border: rgba(122, 140, 228, 0.26);
            --border-soft: rgba(120, 132, 210, 0.18);
            --text: #f5f6ff;
            --text-muted: rgba(201, 205, 238, 0.74);
            --accent: #7c8aff;
            --accent-strong: #5663ff;
            --accent-soft: rgba(120, 136, 255, 0.18);
            --shadow-lg: 0 32px 72px rgba(2, 2, 30, 0.58);
            --shadow-md: 0 16px 40px rgba(6, 8, 35, 0.45);
            --shadow-sm: 0 8px 20px rgba(6, 10, 32, 0.32);
            --radius-lg: 28px;
            --radius-md: 20px;
            --radius-sm: 12px;
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 56px 24px 64px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            background: var(--bg);
            background-image: var(--bg-accent);
            font-family: "Segoe UI", -apple-system, system-ui, BlinkMacSystemFont, "Helvetica Neue", sans-serif;
            color: var(--text);
        }

        main {
            width: min(1040px, 100%);
            background: linear-gradient(155deg, rgba(25, 26, 38, 0.94), rgba(18, 20, 34, 0.96));
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            backdrop-filter: blur(18px);
        }

        header.page-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 32px;
            padding: 40px clamp(28px, 4vw, 56px) 36px;
            background: linear-gradient(140deg, rgba(42, 46, 86, 0.78), rgba(26, 28, 52, 0.94));
            border-bottom: 1px solid var(--border);
        }

        header.page-header h1 {
            margin: 0 0 10px;
            font-size: 28px;
            letter-spacing: 0.02em;
        }

        header.page-header p {
            margin: 0;
            font-size: 14px;
            line-height: 1.65;
            color: var(--text-muted);
            max-width: 520px;
        }

        .header-actions {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        button {
            appearance: none;
            border: 1px solid var(--border);
            border-radius: 999px;
            padding: 10px 20px;
            font-size: 13px;
            letter-spacing: 0.02em;
            font-weight: 600;
            color: var(--text);
            background: rgba(18, 20, 32, 0.85);
            box-shadow: var(--shadow-sm);
            cursor: pointer;
            transition: transform 0.12s ease, background 0.12s ease, box-shadow 0.12s ease;
        }

        button:hover:not(:disabled) {
            background: rgba(40, 42, 68, 0.92);
            transform: translateY(-1px);
        }

        button:active:not(:disabled) {
            transform: translateY(0);
            box-shadow: none;
        }

        button:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        button:disabled {
            cursor: default;
            opacity: 0.45;
            box-shadow: none;
        }

        button.primary {
            background: linear-gradient(120deg, var(--accent-strong), var(--accent));
            border-color: rgba(130, 150, 255, 0.4);
            color: #f8f8fe;
        }

        button.primary:hover:not(:disabled) {
            background: linear-gradient(120deg, #6070ff, #8c9bff);
        }

        button.primary[data-dirty="true"] {
            box-shadow: 0 0 0 2px rgba(124, 138, 255, 0.18), var(--shadow-md);
        }

        .page-body {
            display: grid;
            grid-template-columns: 240px 1fr;
            gap: 32px;
            padding: clamp(24px, 3vw, 38px) clamp(28px, 4vw, 56px) clamp(40px, 5vw, 60px);
        }

        nav.toc {
            position: sticky;
            top: 40px;
            align-self: start;
            background: var(--surface-alt);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 22px 20px;
            box-shadow: var(--shadow-sm);
        }

        nav.toc h2 {
            margin: 0 0 12px;
            font-size: 12px;
            letter-spacing: 0.18em;
            color: rgba(190, 198, 248, 0.62);
            text-transform: uppercase;
        }

        nav.toc ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: grid;
            gap: 8px;
        }

        nav.toc a {
            display: block;
            padding: 9px 12px;
            border-radius: 12px;
            color: inherit;
            text-decoration: none;
            font-weight: 600;
            font-size: 13px;
            letter-spacing: 0.01em;
            transition: background 0.12s ease, transform 0.12s ease;
        }

        nav.toc a:hover,
        nav.toc a:focus-visible {
            background: var(--accent-soft);
            outline: none;
            transform: translateX(4px);
        }

        .settings-content {
            display: flex;
            flex-direction: column;
            gap: 26px;
        }

        section.settings-section {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 28px clamp(22px, 4vw, 36px);
            box-shadow: var(--shadow-sm);
            scroll-margin-top: 88px;
        }

        section.settings-section h2 {
            margin: 0 0 6px;
            font-size: 16px;
            letter-spacing: 0.08em;
            text-transform: uppercase;
            color: rgba(190, 198, 248, 0.82);
        }

        section.settings-section .section-hint {
            margin: 0 0 18px;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-muted);
        }

        .settings-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .setting-row {
            display: grid;
            grid-template-columns: 42px 1fr;
            gap: 18px;
            align-items: center;
            padding: 16px;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(120, 138, 230, 0.14);
            background: rgba(28, 30, 48, 0.68);
            transition: border-color 0.15s ease, background 0.15s ease, box-shadow 0.15s ease;
        }

        .setting-row:hover {
            border-color: rgba(124, 138, 255, 0.42);
            background: rgba(34, 36, 58, 0.82);
        }

        .setting-row input[type="checkbox"] {
            width: 22px;
            height: 22px;
            accent-color: var(--accent);
            cursor: pointer;
        }

        .setting-row input[type="checkbox"]:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 3px;
        }

        .setting-copy {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .setting-title-line {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .setting-title {
            font-size: 15px;
            font-weight: 600;
        }

        .setting-note {
            display: inline-flex;
            align-items: center;
            padding: 2px 7px;
            border-radius: 999px;
            background: rgba(124, 138, 255, 0.22);
            color: var(--accent);
            font-size: 11px;
            letter-spacing: 0.12em;
            text-transform: uppercase;
        }

        .setting-description {
            display: block;
            font-size: 13px;
            line-height: 1.6;
            color: var(--text-muted);
        }

        .setting-row-dirty {
            border-color: rgba(130, 150, 255, 0.75);
            background: rgba(48, 52, 88, 0.85);
            box-shadow: inset 0 0 0 1px rgba(146, 162, 255, 0.4);
        }

        footer.page-footer {
            display: flex;
            flex-wrap: wrap;
            gap: 8px 20px;
            align-items: center;
            justify-content: center;
            padding: 20px clamp(20px, 4vw, 48px) 28px;
            background: rgba(18, 19, 32, 0.92);
            border-top: 1px solid var(--border);
            font-size: 13px;
            color: var(--text-muted);
        }

        code {
            font-family: "Cascadia Mono", "SFMono-Regular", Consolas, monospace;
            font-size: 12px;
            padding: 2px 6px;
            border-radius: 8px;
            background: rgba(28, 30, 48, 0.92);
            border: 1px solid rgba(132, 148, 226, 0.28);
            color: var(--text);
        }

        a {
            color: inherit;
        }

        @media (max-width: 980px) {
            .page-body {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            nav.toc {
                position: static;
                order: -1;
                display: flex;
                flex-direction: column;
                gap: 12px;
            }

            nav.toc ul {
                display: flex;
                flex-wrap: wrap;
                gap: 10px;
            }

            nav.toc a {
                padding: 8px 14px;
            }
        }

        @media (max-width: 640px) {
            body {
                padding: 28px 16px 40px;
            }

            header.page-header {
                flex-direction: column;
                align-items: stretch;
            }

            .header-actions {
                justify-content: flex-start;
            }

            button {
                width: 100%;
                justify-content: center;
            }

            .setting-row {
                grid-template-columns: 1fr;
                padding: 18px;
            }

            .setting-row input[type="checkbox"] {
                justify-self: flex-start;
            }
        }
    </style>
</head>

<body>
    <main>
        <header class="page-header">
            <div class="header-copy">
                <h1>Browser Settings</h1>
                <p>Fine-tune how Ultralight looks, behaves, and protects your browsing. Changes apply immediately; use
                    Save to keep them for the next launch.</p>
            </div>
            <div class="header-actions">
                <button id="restore-defaults" type="button">Restore Defaults</button>
                <button id="save-settings" class="primary" type="button" disabled>Save Changes</button>
            </div>
        </header>
        <div class="page-body">
            <nav class="toc" aria-label="Settings sections">
                <h2>Sections</h2>
                <ul id="section-links"></ul>
            </nav>
            <div class="settings-content" id="settings-content" aria-live="polite"></div>
        </div>
        <footer class="page-footer">
            <span>Unsaved changes stay in this tab until you press Save.</span>
            <span>Stored at <code id="settings-save-path">data/settings.json</code>.</span>
        </footer>
    </main>
    <script>
        (function () {
            'use strict';

            const KNOWN_CATEGORIES = [
                {
                    id: 'appearance',
                    title: 'Appearance',
                    description: 'Adjust the chrome, window treatments, and visual polish to match your workspace.'
                },
                {
                    id: 'accessibility',
                    title: 'Accessibility & Motion',
                    description: 'Reduce motion and boost contrast so the interface stays comfortable on every display.'
                },
                {
                    id: 'privacy',
                    title: 'Privacy & Content',
                    description: 'Choose how Ultralight filters requests, records history, and handles background activity.'
                },
                {
                    id: 'suggestions',
                    title: 'Suggestions',
                    description: 'Control the address bar helper so it surfaces only the hints you find useful.'
                },
                {
                    id: 'downloads',
                    title: 'Downloads',
                    description: 'Decide how download progress and notifications appear while files transfer.'
                }
            ];

            const restoreBtn = document.getElementById('restore-defaults');
            const saveBtn = document.getElementById('save-settings');
            const contentRoot = document.getElementById('settings-content');
            const tocList = document.getElementById('section-links');
            const savePathEl = document.getElementById('settings-save-path');

            const rowsByKey = new Map();
            const inputsByKey = new Map();
            const defaultsByKey = new Map();

            let baselineValues = {};
            let currentValues = {};
            let isDirty = false;
            let lastCatalogSignature = '';

            function fallbackCategory(id) {
                if (!id) {
                    return { id: 'misc', title: 'Other', description: '' };
                }
                const normalized = String(id);
                const title = normalized.replace(/[-_]+/g, ' ').replace(/\b\w/g, (c) => c.toUpperCase());
                return { id: normalized, title: title.trim() || 'Other', description: '' };
            }

            function stringifyCatalog(entries) {
                return entries.map((entry) => {
                    if (!entry) return '';
                    const key = entry.key ? String(entry.key) : '';
                    const category = entry.category ? String(entry.category) : '';
                    const name = entry.name ? String(entry.name) : '';
                    const note = entry.note ? String(entry.note) : '';
                    const description = entry.description ? String(entry.description) : '';
                    return key + '|' + category + '|' + name + '|' + note + '|' + description;
                }).join(';');
            }

            function groupCatalog(entries) {
                const groups = new Map();
                entries.forEach((entry) => {
                    if (!entry || !entry.key) return;
                    const category = entry.category ? String(entry.category) : 'misc';
                    if (!groups.has(category)) {
                        groups.set(category, []);
                    }
                    groups.get(category).push(entry);
                });
                groups.forEach((items) => {
                    items.sort((a, b) => {
                        const aName = (a.name || a.key || '').toLowerCase();
                        const bName = (b.name || b.key || '').toLowerCase();
                        return aName.localeCompare(bName);
                    });
                });
                return groups;
            }

            function renderCatalog(entries) {
                if (!Array.isArray(entries)) return;

                const signature = stringifyCatalog(entries);
                if (signature === lastCatalogSignature && rowsByKey.size) {
                    defaultsByKey.clear();
                    entries.forEach((entry) => {
                        if (entry && entry.key && typeof entry.default === 'boolean') {
                            defaultsByKey.set(String(entry.key), !!entry.default);
                        }
                    });
                    return;
                }
                lastCatalogSignature = signature;

                const groups = groupCatalog(entries);
                const ordered = [];
                KNOWN_CATEGORIES.forEach((info) => {
                    if (groups.has(info.id)) {
                        ordered.push({ info, entries: groups.get(info.id) });
                        groups.delete(info.id);
                    }
                });

                Array.from(groups.entries()).sort((a, b) => a[0].localeCompare(b[0])).forEach(([id, items]) => {
                    ordered.push({ info: fallbackCategory(id), entries: items });
                });

                contentRoot.textContent = '';
                tocList.textContent = '';
                rowsByKey.clear();
                inputsByKey.clear();
                defaultsByKey.clear();

                ordered.forEach(({ info, entries: categoryEntries }) => {
                    if (!categoryEntries.length) return;

                    const section = document.createElement('section');
                    section.className = 'settings-section';
                    section.id = info.id;
                    section.setAttribute('aria-labelledby', info.id + '-heading');

                    const heading = document.createElement('h2');
                    heading.id = info.id + '-heading';
                    heading.textContent = info.title || 'Settings';
                    section.appendChild(heading);

                    if (info.description) {
                        const hint = document.createElement('p');
                        hint.className = 'section-hint';
                        hint.textContent = info.description;
                        section.appendChild(hint);
                    }

                    const list = document.createElement('div');
                    list.className = 'settings-list';
                    list.dataset.settingsCategory = info.id;
                    section.appendChild(list);

                    categoryEntries.forEach((entry) => {
                        if (!entry || !entry.key) return;
                        const key = String(entry.key);

                        const row = document.createElement('label');
                        row.className = 'setting-row';
                        row.dataset.settingKey = key;

                        const input = document.createElement('input');
                        input.type = 'checkbox';
                        input.dataset.key = key;
                        const inputId = 'setting-toggle-' + key;
                        input.id = inputId;
                        row.appendChild(input);

                        const copy = document.createElement('div');
                        copy.className = 'setting-copy';

                        const titleLine = document.createElement('div');
                        titleLine.className = 'setting-title-line';

                        const title = document.createElement('span');
                        title.className = 'setting-title';
                        title.id = key + '-title';
                        title.textContent = entry.name || key;
                        titleLine.appendChild(title);

                        const note = document.createElement('span');
                        note.className = 'setting-note';
                        if (entry.note) {
                            note.textContent = entry.note;
                            note.hidden = false;
                        } else {
                            note.hidden = true;
                        }
                        titleLine.appendChild(note);
                        copy.appendChild(titleLine);

                        const description = document.createElement('span');
                        description.className = 'setting-description';
                        description.id = key + '-description';
                        description.textContent = entry.description || '';
                        copy.appendChild(description);

                        row.appendChild(copy);
                        list.appendChild(row);

                        rowsByKey.set(key, row);
                        inputsByKey.set(key, input);
                        if (typeof entry.default === 'boolean') {
                            defaultsByKey.set(key, !!entry.default);
                        }

                        input.setAttribute('aria-labelledby', title.id);
                        input.setAttribute('aria-describedby', description.id);

                        input.addEventListener('change', () => {
                            if (input.disabled) return;
                            const checked = !!input.checked;
                            currentValues[key] = checked;
                            markRowDirty(key);
                            isDirty = true;
                            updateSaveButtonState();
                            pushSetting(key, checked);
                        });
                    });

                    contentRoot.appendChild(section);

                    const li = document.createElement('li');
                    const link = document.createElement('a');
                    link.href = '#' + info.id;
                    link.textContent = info.title || 'Settings';
                    li.appendChild(link);
                    tocList.appendChild(li);
                });
            }

            function normalizePayload(payload) {
                if (typeof payload === 'string') {
                    try {
                        return JSON.parse(payload || '{}');
                    } catch (err) {
                        return null;
                    }
                }
                return payload && typeof payload === 'object' ? payload : null;
            }

            function coercePayload(payload) {
                const parsed = normalizePayload(payload);
                if (!parsed) return null;
                const values = parsed.values && typeof parsed.values === 'object' ? parsed.values : {};
                const meta = parsed.meta && typeof parsed.meta === 'object' ? parsed.meta : {};
                return { values, meta };
            }

            function hasDiff(next, baseline) {
                const keys = new Set([
                    ...Object.keys(next || {}),
                    ...Object.keys(baseline || {})
                ]);
                for (const key of keys) {
                    if (!!next[key] !== !!baseline[key]) {
                        return true;
                    }
                }
                return false;
            }

            function updateDirtyRows(dirtyKeys) {
                const dirtySet = new Set(Array.isArray(dirtyKeys) ? dirtyKeys.map(String) : []);
                rowsByKey.forEach((row, key) => {
                    if (dirtySet.has(key)) {
                        row.classList.add('setting-row-dirty');
                    } else {
                        row.classList.remove('setting-row-dirty');
                    }
                });
            }

            function markRowDirty(key) {
                const row = rowsByKey.get(key);
                if (!row) return;
                row.classList.add('setting-row-dirty');
            }

            function updateSaveButtonState() {
                if (!saveBtn) return;
                saveBtn.disabled = !isDirty;
                if (isDirty) {
                    saveBtn.dataset.dirty = 'true';
                } else {
                    delete saveBtn.dataset.dirty;
                }
            }

            function updateSavePath(path) {
                if (!savePathEl || typeof path !== 'string') return;
                if (path.length) {
                    savePathEl.textContent = path;
                }
            }

            function pushSetting(key, value) {
                if (typeof window.OnUpdateSetting !== 'function') return;
                try {
                    window.OnUpdateSetting(String(key || ''), !!value);
                } catch (err) {
                    /* ignore bridge failures */
                }
            }

            function applySettingsState(payload) {
                const coerced = coercePayload(payload);
                if (!coerced) return;
                const { values, meta } = coerced;

                if (meta && Array.isArray(meta.catalog)) {
                    renderCatalog(meta.catalog);
                    meta.catalog.forEach((entry) => {
                        if (entry && entry.key && typeof entry.default === 'boolean') {
                            defaultsByKey.set(String(entry.key), !!entry.default);
                        }
                    });
                }

                currentValues = {};

                inputsByKey.forEach((input, key) => {
                    let nextValue;
                    if (Object.prototype.hasOwnProperty.call(values, key)) {
                        nextValue = !!values[key];
                    } else if (defaultsByKey.has(key)) {
                        nextValue = defaultsByKey.get(key);
                    } else {
                        nextValue = !!input.checked;
                    }
                    input.checked = nextValue;
                    currentValues[key] = nextValue;
                });

                if (meta && Array.isArray(meta.dirty_keys)) {
                    updateDirtyRows(meta.dirty_keys);
                } else {
                    updateDirtyRows([]);
                }

                if (meta && typeof meta.storage_path === 'string') {
                    updateSavePath(meta.storage_path);
                }

                if ((meta && meta.baseline === true) || !Object.keys(baselineValues).length) {
                    baselineValues = Object.assign({}, currentValues);
                }

                if (meta && typeof meta.dirty === 'boolean') {
                    isDirty = meta.dirty;
                } else {
                    isDirty = hasDiff(currentValues, baselineValues);
                }

                if (!isDirty && meta && Array.isArray(meta.dirty_keys) && meta.dirty_keys.length) {
                    isDirty = true;
                }

                updateSaveButtonState();
            }

            function refreshSnapshot() {
                if (typeof window.GetSettingsSnapshot !== 'function') return;
                try {
                    const payload = window.GetSettingsSnapshot();
                    applySettingsState(payload);
                } catch (err) {
                    /* ignore bridge failures */
                }
            }

            function requestDefaults() {
                if (typeof window.OnRestoreSettingsDefaults !== 'function') return;
                try {
                    const payload = window.OnRestoreSettingsDefaults();
                    applySettingsState(payload);
                } catch (err) {
                    /* ignore bridge failures */
                }
            }

            function requestSave() {
                if (!saveBtn || saveBtn.disabled) return;
                if (typeof window.OnSaveSettings === 'function') {
                    try {
                        window.OnSaveSettings();
                    } catch (err) {
                        /* ignore bridge failures */
                    }
                }
                isDirty = false;
                rowsByKey.forEach((row) => row.classList.remove('setting-row-dirty'));
                baselineValues = Object.assign({}, currentValues);
                updateSaveButtonState();
            }

            if (restoreBtn) {
                restoreBtn.addEventListener('click', requestDefaults);
            }

            if (saveBtn) {
                saveBtn.addEventListener('click', requestSave);
            }

            document.addEventListener('keydown', (event) => {
                if ((event.ctrlKey || event.metaKey) && String(event.key).toLowerCase() === 's') {
                    event.preventDefault();
                    requestSave();
                }
            });

            document.addEventListener('visibilitychange', () => {
                if (!document.hidden) {
                    refreshSnapshot();
                }
            });

            window.addEventListener('focus', refreshSnapshot);

            window.applySettingsState = applySettingsState;

            refreshSnapshot();
        })();
    </script>
</body>

</html>