<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Browser Settings</title>
  <link rel="stylesheet" type="text/css" href="ui.css">
  <style>
    body {
      margin: 0;
      font-family: "Segoe UI", -apple-system, Ubuntu, Arial, sans-serif;
      font-size: 14px;
      color: #d8d7e6;
      background: transparent;
    }

    .settings-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(13, 13, 20, 0.72);
      backdrop-filter: blur(12px);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 32px;
    }

    .settings-dialog {
      width: 520px;
      max-width: 92vw;
      max-height: 90vh;
      border-radius: 14px;
      border: 1px solid rgba(80, 80, 110, 0.5);
      background: rgba(30, 30, 44, 0.96);
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.45);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .settings-header {
      padding: 20px 24px 12px;
      border-bottom: 1px solid rgba(70, 70, 100, 0.45);
    }

    .settings-header h1 {
      margin: 0;
      font-size: 20px;
      font-weight: 600;
      color: #f0f0ff;
    }

    .settings-content {
      padding: 20px 24px;
      overflow-y: auto;
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .settings-group h2 {
      margin: 0 0 10px;
      font-size: 15px;
      font-weight: 600;
      color: #f7f7ff;
      letter-spacing: 0.2px;
    }

    .setting-row {
      display: flex;
      align-items: flex-start;
      gap: 10px;
      padding: 9px 0;
      border-bottom: 1px solid rgba(70, 70, 100, 0.25);
    }

    .setting-row:last-child {
      border-bottom: none;
    }

    .setting-row input[type="checkbox"] {
      margin-top: 3px;
      accent-color: #6c63ff;
    }

    .setting-label {
      flex: 1;
    }

    .setting-label strong {
      display: block;
      font-weight: 600;
      color: #f0f0ff;
      margin-bottom: 2px;
    }

    .setting-label span {
      color: #b4b3c6;
      font-size: 13px;
      line-height: 1.4;
    }

    .settings-footer {
      padding: 16px 24px 20px;
      border-top: 1px solid rgba(70, 70, 100, 0.35);
      display: flex;
      justify-content: space-between;
      gap: 12px;
    }

    .settings-footer button {
      border: none;
      border-radius: 10px;
      font-size: 14px;
      padding: 10px 18px;
      cursor: pointer;
      background: #38384b;
      color: #f0f0ff;
      transition: background 0.18s ease;
    }

    .settings-footer button:hover {
      background: #45455f;
    }

    .settings-footer button.primary {
      background: linear-gradient(180deg, #6c63ff, #5650d4);
      color: #fff;
    }

    .settings-footer button.primary:hover {
      background: linear-gradient(180deg, #7d75ff, #6760eb);
    }

    @media (max-width: 640px) {
      .settings-dialog {
        width: 100%;
        max-height: 100vh;
      }
      .settings-backdrop {
        padding: 12px;
      }
    }
  </style>
</head>
<body>
  <div id="settings-backdrop" class="settings-backdrop">
    <div class="settings-dialog" role="dialog" aria-modal="true" aria-labelledby="settings-title">
      <div class="settings-header">
        <h1 id="settings-title">Settings</h1>
      </div>
      <div class="settings-content">
        <section class="settings-group" aria-labelledby="appearance-group">
          <h2 id="appearance-group">Appearance</h2>
          <label class="setting-row">
            <input type="checkbox" data-key="launch_dark_theme">
            <div class="setting-label">
              <strong>Launch in dark theme</strong>
              <span>Automatically applies the dark stylesheet to all pages when the browser starts.</span>
            </div>
          </label>
          <label class="setting-row">
            <input type="checkbox" data-key="experimental_transparent_toolbar">
            <div class="setting-label">
              <strong>Transparent toolbar (experimental)</strong>
              <span>Enable a glass-like toolbar background. May cause readability issues on bright pages.</span>
            </div>
          </label>
          <label class="setting-row">
            <input type="checkbox" data-key="experimental_compact_tabs">
            <div class="setting-label">
              <strong>Compact tabs (experimental)</strong>
              <span>Reduces tab height and spacing to show more tabs at once.</span>
            </div>
          </label>
        </section>

        <section class="settings-group" aria-labelledby="privacy-group">
          <h2 id="privacy-group">Privacy &amp; Content</h2>
          <label class="setting-row">
            <input type="checkbox" data-key="enable_adblock">
            <div class="setting-label">
              <strong>Enable ad blocking</strong>
              <span>Blocks requests using the built-in filter lists. Disable to allow all content.</span>
            </div>
          </label>
          <label class="setting-row">
            <input type="checkbox" data-key="log_blocked_requests">
            <div class="setting-label">
              <strong>Log blocked requests</strong>
              <span>Prints blocked URL details to the console for debugging.</span>
            </div>
          </label>
          <label class="setting-row">
            <input type="checkbox" data-key="clear_history_on_exit">
            <div class="setting-label">
              <strong>Clear history on exit</strong>
              <span>Removes browsing history when the browser closes and skips saving new history to disk.</span>
            </div>
          </label>
        </section>

        <section class="settings-group" aria-labelledby="suggestions-group">
          <h2 id="suggestions-group">Suggestions</h2>
          <label class="setting-row">
            <input type="checkbox" data-key="enable_suggestions">
            <div class="setting-label">
              <strong>Show address bar suggestions</strong>
              <span>Displays frequently visited sites and history matches while typing.</span>
            </div>
          </label>
          <label class="setting-row">
            <input type="checkbox" data-key="enable_suggestion_favicons">
            <div class="setting-label">
              <strong>Show favicons in suggestions</strong>
              <span>Displays site icons next to suggestion entries when available.</span>
            </div>
          </label>
        </section>

        <section class="settings-group" aria-labelledby="downloads-group">
          <h2 id="downloads-group">Downloads</h2>
          <label class="setting-row">
            <input type="checkbox" data-key="show_download_badge">
            <div class="setting-label">
              <strong>Show download badge</strong>
              <span>Displays a badge on the toolbar icon while downloads are active.</span>
            </div>
          </label>
          <label class="setting-row">
            <input type="checkbox" data-key="auto_open_download_panel">
            <div class="setting-label">
              <strong>Open downloads panel automatically</strong>
              <span>Automatically opens the downloads overlay when a download starts.</span>
            </div>
          </label>
        </section>
      </div>
      <div class="settings-footer">
        <button id="restore-defaults" type="button">Restore Defaults</button>
        <div style="display:flex; gap:10px;">
          <button id="close-settings" type="button">Close</button>
          <button id="apply-settings" class="primary" type="button">Done</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const backdrop = document.getElementById('settings-backdrop');
      const dialog = document.querySelector('.settings-dialog');
      const restoreBtn = document.getElementById('restore-defaults');
      const closeBtn = document.getElementById('close-settings');
      const doneBtn = document.getElementById('apply-settings');
      const inputs = Array.from(document.querySelectorAll('input[type="checkbox"][data-key]'));

      function normalizePayload(payload) {
        if (typeof payload === 'string') {
          try { return JSON.parse(payload || '{}'); } catch (e) { return null; }
        }
        return (payload && typeof payload === 'object') ? payload : null;
      }

      function applySettingsState(payload) {
        const state = normalizePayload(payload);
        if (!state) return;
        inputs.forEach((input) => {
          const key = input.getAttribute('data-key');
          if (Object.prototype.hasOwnProperty.call(state, key)) {
            input.checked = !!state[key];
          }
        });
      }

      function pushSetting(key, value) {
        if (window.OnUpdateSetting) {
          try { OnUpdateSetting(String(key || ''), !!value); } catch (e) { }
        }
      }

      function closePanel() {
        if (window.OnCloseSettingsPanel) {
          try { OnCloseSettingsPanel(); } catch (e) { }
        }
      }

      inputs.forEach((input) => {
        input.addEventListener('change', () => {
          const key = input.getAttribute('data-key');
          if (!key) return;
          pushSetting(key, input.checked);
        });
      });

      restoreBtn.addEventListener('click', () => {
        if (window.OnRestoreSettingsDefaults) {
          try {
            const raw = OnRestoreSettingsDefaults();
            applySettingsState(raw);
          } catch (e) { }
        }
      });

      closeBtn.addEventListener('click', closePanel);
      doneBtn.addEventListener('click', closePanel);

      backdrop.addEventListener('click', (e) => {
        if (e.target === backdrop) closePanel();
      });

      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
          e.preventDefault();
          closePanel();
        }
      });

      window.applySettingsState = applySettingsState;

      if (window.GetSettingsSnapshot) {
        try {
          const raw = GetSettingsSnapshot();
          applySettingsState(raw);
        } catch (e) { }
      }
    })();
  </script>
</body>
</html>
